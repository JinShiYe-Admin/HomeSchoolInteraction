<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>学校通知列表界面</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			.comment_inner {
				/*width: 200px;*/
				word-break: break-all;
				text-overflow: ellipsis;
				display: -webkit-box;
				/** 对象作为伸缩盒子模型显示 **/
				-webkit-box-orient: vertical;
				/** 设置或检索伸缩盒对象的子元素的排列方式 **/
				-webkit-line-clamp: 2;
				/** 显示的行数 **/
				overflow: hidden;
				/** 隐藏超出的内容 **/
			}
			
			.nameTime {
				font-size: 12px;
				color: #999999;
				padding-top: 15px;
			}
			
			p {
				text-overflow: ellipsis;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				margin-right: 10px;
			}
		</style>
	</head>

	<body style="background: white;">
		<header class="mui-bar mui-bar-nav" style="background-color:#63BBFF;" id="tempVue">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;"></a>
			<h1 class="mui-title" style="color: white;">学校通知</h1>
			<a @click="revoke()" class="mui-pull-right" style="color: white;font-size: 25px;margin-top: 10px;">+</a>
		</header>
		<div class="mui-content" id="noticelistData" style="margin-top: -40px;">
			<ul class="mui-table-view" v-for="(noticeModel,index) in noticeArray">
				<li class="mui-table-view-cell" @click="clickNoticeList(noticeModel)">
					<div class="mui-navigate-right">
						<div id="" v-if="noticeModel.IsRead==0">
							<image v-if="noticeModel.IsRead==0" src="../../img/homeSchool/redColor.png" style="width: 7px;height: 7px;border-radius: 50%;" />
							<p style="font-size: 15px;color: #333333;margin-top: -17px;margin-left: 12px;">{{noticeModel.NoticeContent}}</p>
						</div>
						<div id="" v-else="">
							<image v-if="noticeModel.IsRead==0" src="../../img/homeSchool/redColor.png" style="width: 7px;height: 7px;border-radius: 50%;" />
							<p style="font-size: 15px;color: #333333;margin-left: 12px;">{{noticeModel.NoticeContent}}</p>
						</div>
						<div class="">
							<image :src=noticeModel.SendManImg style="width: 15px;height: 15px;border-radius: 50%;vertical-align: middle;" />
							<span class="nameTime">{{noticeModel.SendManName}}  {{noticeModel.SendTime}}</span>

						</div>
						<div id="" v-if="noticeModel.ReadCnt==0&&noticeModel.ReplyCnt==0&&noticeModel.SendManId==personal.utid&&noticeModel.SmsSync==0">
							<button @click.stop="deleteNotice(noticeModel)" type="button" style="width: 50px;margin-top: -20px;border: 0px;font-size: 12px;color: #ff6666;float: right;margin-right: 10px;">删除</button>
						</div>
						<div id="" v-else="">
							<image src='../../img/homeSchool/lookCount.png' style="width: 10px;height: 10px;border-radius: 50%;" />
							<span class="nameTime">{{noticeModel.ReadCnt}}</span>
							<image src="../../img/homeSchool/contentCount.png" style="width: 10px;height: 10px;border-radius: 50%;" />
							<span class="nameTime" style="padding-right: 10px;">{{noticeModel.ReplyCnt}}</span>
						</div>
					</div>
				</li>
			</ul>
		</div>

		<script src="../../js/mui.min.js"></script>
		<script src="../../js/utils/vue.min.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/utils/events.js"></script>
		<script src="../../js/libs/jquery.js"></script>
		<script src="../../js/publicProtocolNew.js"></script>
		<!--<script src="../../js/publicProtocol.js"></script>-->
		<script type="text/javascript" src="../../js/utils/vconsole.min.js"></script>
		<!--加密-->
		<script src="../../js/libs/RSA/Barrett.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/BigInt.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/libs/RSA/RSA.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils/RSAEncrypt.js" type="text/javascript" charset="utf-8"></script>
		<!---->
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/utils/signHmacSHA1.js'></script>
		<script src='../../js/utils/sortSign.js'></script>
		<script src="../../js/storageKeyName.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script type="text/javascript">
			//获取个人信息
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			console.log('personal:' + JSON.stringify(personal));
			mui.init({
				pullRefresh: {
					container: '#noticelistData',
					down: {
						style: 'circle',
						callback: pulldownRefresh
					},
					up: {
						auto: true,
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});
			mui.plusReady(function() {
				curPage = utils.getDataFromUrl(window.location.href);
				console.log('2222:' + JSON.stringify(curPage));
			});

			//加载更多
			function pullupRefresh() {
				noticelistData.flag = 1;
				//				noticelistData.pageIndex = 1;
				//4.获取学校通知列表
				getNoticesList();
			}

			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				noticelistData.flag = 0;
				noticelistData.pageIndex = 1;
				//4.获取学校通知列表
				getNoticesList();
			}

			var noticelistData = new Vue({
				el: "#noticelistData",
				data: {
					flag: 0, //0刷新，1加载更多
					noticeArray: [], //通知列表数组
					pageIndex: 1 //第几页
				},
				methods: {
					clickNoticeList: function(model) {
						console.log('点击li：' + model);
						model.IsRead = 1;
						utils.mOpenWithData("../../html/homeSchool/noticeDetail.html", model);
					},
					deleteNotice: function(noticeModel) {
						mui.confirm('', '确定删除？', ['取消', '确认'], function(e) {
							if(e.index == 1) {
								//2.删除学校通知（假删）
								var tempData1 = {
									noticeId: noticeModel.NoticeId //通知ID
								}
								events.showWaiting();
								//2.删除学校通知（假删）
								setNoticesDelPro(tempData1, function function_name(data) {
									events.closeWaiting();
									if(data.RspCode == 0) {
										pulldownRefresh();
									} else {
										mui.toast(data.RspTxt);
									}
								});
							}
						}, 'div')

					}
				}
			});

			var tempVue = new Vue({
				el: "#tempVue",
				data: {

				},
				methods: {
					revoke: function() {
						console.log('add通知');
						utils.mOpenWithData("../../html/homeSchool/notice_add.html", {});
					}
				}
			});

			//4.获取学校通知列表
			var getNoticesList = function() {
				var tempData = {
					schoolId: personal.schid, //学校ID,统一部署的时候，学校ID传000000
					manId: personal.utid, //登录人ID
					status: 1, //状态,0 全部,1 有效,2 无效
					pageIndex: noticelistData.pageIndex, //当前页数
					pageSize: 10 //每页记录数,0为全部
				}
				events.showWaiting();
				getNoticesPro(tempData, function function_name(data) {
					events.closeWaiting();
					mui('#noticelistData').pullRefresh().endPullupToRefresh(); //参数为true代表没有更多数据了。
					mui('#noticelistData').pullRefresh().endPulldownToRefresh();
					console.log('data:' + JSON.stringify(data));
					if(data.RspCode == 0) {
						noticelistData.pageIndex++;
						for(var i = 0; i < data.RspData.Data.length; i++) {
							var model = data.RspData.Data[i];
							model.SendTime = modifyTimeFormat(model.SendTime);
						}
						if(noticelistData.flag == 0) { //刷新

							noticelistData.noticeArray = data.RspData.Data;
						} else { //加载更多
							noticelistData.noticeArray = noticelistData.noticeArray.concat(data.RspData.Data);

						}
					} else {
						mui.toast(data.RspTxt);
					}
				});
			}
		</script>
	</body>

</html>